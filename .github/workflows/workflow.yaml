name: CI/CD Medical Model Pipeline

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # Comentario inicial en el PR
    - name: Comment PR - Start
      if: github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@v2
      with:
        message: |
          üöÄ **CI/CD en acci√≥n. Ejecutando tareas...** 
          
          Se est√°n ejecutando las siguientes verificaciones:
          - ‚úÖ Configuraci√≥n de entorno Python
          - ‚úÖ Instalaci√≥n de dependencias
          - ‚úÖ Ejecuci√≥n de pruebas unitarias
          - ‚úÖ Verificaci√≥n de funcionalidad de endpoints
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    
    # Checkout del c√≥digo
    - uses: actions/checkout@v4
    
    # Configurar Python
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    
    # Instalar dependencias
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Ejecutar las pruebas
    - name: Run tests with pytest
      run: |
        pytest test_app.py -v --tb=short
    
    # Comentario final de √©xito
    - name: Comment PR - Success
      if: success() && github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@v2
      with:
        message: |
          ‚úÖ **CI/CD terminado con √©xito.**
          
          üìä **Resumen de resultados:**
          - ‚úÖ Todas las pruebas unitarias pasaron correctamente
          - ‚úÖ Endpoints de API funcionando correctamente
          - ‚úÖ L√≥gica de predicci√≥n m√©dica validada
          - ‚úÖ Sistema de estad√≠sticas verificado
          
          üéâ El c√≥digo est√° listo para ser integrado a la rama main.
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
    
    # Comentario final de fallo
    - name: Comment PR - Failure
      if: failure() && github.event_name == 'pull_request'
      uses: thollander/actions-comment-pull-request@v2
      with:
        message: |
          ‚ùå **CI/CD terminado con errores.**
          
          üí• **Se encontraron problemas:**
          - Las pruebas unitarias fallaron
          - Revisa los logs de ejecuci√≥n para m√°s detalles
          - Corrige los errores antes de hacer merge a main
          
          üîß Por favor, revisa el c√≥digo y ejecuta las pruebas localmente antes de hacer push.
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  # Job para deploy cuando se hace push/merge a main
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: test
    
    steps:
    # Checkout del c√≥digo
    - uses: actions/checkout@v4
    
    # Configurar Python para pruebas finales
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    
    # Instalar dependencias
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Ejecutar pruebas finales en main
    - name: Run final tests on main
      run: |
        echo "üß™ Ejecutando pruebas finales en la rama main..."
        pytest test_app.py -v --tb=short
        echo "‚úÖ Todas las pruebas finales pasaron correctamente"
    
    # Configurar Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    # Login a GitHub Container Registry
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GH_TOKEN }}
    
    # Construir y publicar imagen Docker
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/medical-model-mlops-u2:latest
          ghcr.io/${{ github.repository_owner }}/medical-model-mlops-u2:${{ github.sha }}
        labels: |
          org.opencontainers.image.title=Medical Model MLOps
          org.opencontainers.image.description=Servicio m√©dico de diagn√≥stico con ML simulado
          org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.version=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
    
    # Notificaci√≥n de √©xito
    - name: Deployment Success Notification
      run: |
        echo "üöÄ ¬°Despliegue completado exitosamente!"
        echo "üì¶ Imagen Docker publicada en: ghcr.io/${{ github.repository_owner }}/medical-model-mlops-u2:latest"
        echo "üè∑Ô∏è  Tambi√©n disponible como: ghcr.io/${{ github.repository_owner }}/medical-model-mlops-u2:${{ github.sha }}"
        echo "‚úÖ El servicio m√©dico est√° listo para usar"